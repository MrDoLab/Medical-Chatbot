# streamlit_app.py
"""
ì˜ë£Œ AI ì–´ì‹œìŠ¤í„´íŠ¸ ì›¹ ì¸í„°í˜ì´ìŠ¤
- ì™¸ë¶€ ì ‘ì† ê°€ëŠ¥í•œ Streamlit ì„œë²„
- RAG ì‹œìŠ¤í…œê³¼ ì—°ë™
- ì‹¤ì‹œê°„ ì§ˆë¬¸/ë‹µë³€
- ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
- í”„ë¡¬í”„íŠ¸ ì‹¤ì‹œê°„ ê´€ë¦¬
"""

import streamlit as st
import time
import json
import os
import traceback
from datetime import datetime, timedelta
from pathlib import Path
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from typing import Dict, List, Any

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ğŸ¥ ì˜ë£Œ AI ì–´ì‹œìŠ¤í„´íŠ¸",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# RAG ì‹œìŠ¤í…œ ë¡œë“œ (ìºì‹œë¡œ í•œ ë²ˆë§Œ ë¡œë“œ)
@st.cache_resource
def load_rag_system():
    """RAG ì‹œìŠ¤í…œ ë¡œë“œ (í•œ ë²ˆë§Œ ì‹¤í–‰)"""
    try:
        from rag_system import RAGSystem
        rag_system = RAGSystem()
        
        return rag_system
    except Exception as e:
        st.error(f"âŒ RAG ì‹œìŠ¤í…œ ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        return None

# QA í‰ê°€ê¸° ë¡œë“œ
@st.cache_resource
def load_qa_evaluator():
    """QA í‰ê°€ê¸° ë¡œë“œ"""
    try:
        from qa_evaluator import MedicalQAEvaluator
        return MedicalQAEvaluator()
    except Exception as e:
        st.error(f"âŒ QA í‰ê°€ê¸° ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        return None

# í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ì ë¡œë“œ
@st.cache_resource
def load_prompt_manager():
    """í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ì ë¡œë“œ"""
    try:
        from prompt_manager import PromptManager
        return PromptManager()
    except Exception as e:
        st.error(f"âŒ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ì ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
        return None

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
def initialize_session_state():
    """ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'conversation_history' not in st.session_state:
        st.session_state.conversation_history = []
    if 'user_feedback' not in st.session_state:
        st.session_state.user_feedback = []
    if 'system_stats' not in st.session_state:
        st.session_state.system_stats = {}
    if 'user_id' not in st.session_state:
        st.session_state.user_id = f"user_{int(time.time())}"
    if 'current_prompt_type' not in st.session_state:
        st.session_state.current_prompt_type = "RAG_SYSTEM_PROMPT"
    if 'edited_prompts' not in st.session_state:
        st.session_state.edited_prompts = {}
    if 'prompt_edit_history' not in st.session_state:
        st.session_state.prompt_edit_history = []

def save_conversation(question: str, answer: str, response_time: float, sources: int = 0):
    """ëŒ€í™” ì €ì¥"""
    conversation_entry = {
        'timestamp': datetime.now().isoformat(),
        'question': question,
        'answer': answer,
        'response_time': response_time,
        'sources_used': sources,
        'user_id': st.session_state.user_id
    }
    st.session_state.conversation_history.append(conversation_entry)

def save_feedback(question: str, answer: str, rating: str, feedback_text: str = ""):
    """ì‚¬ìš©ì í”¼ë“œë°± ì €ì¥"""
    feedback_entry = {
        'timestamp': datetime.now().isoformat(),
        'question': question,
        'answer': answer,
        'rating': rating,
        'feedback_text': feedback_text,
        'user_id': st.session_state.user_id
    }
    st.session_state.user_feedback.append(feedback_entry)
    
    # ë¡œì»¬ íŒŒì¼ë¡œë„ ì €ì¥
    feedback_file = Path("./logs/streamlit_feedback.json")
    feedback_file.parent.mkdir(exist_ok=True)
    
    try:
        if feedback_file.exists():
            with open(feedback_file, 'r', encoding='utf-8') as f:
                all_feedback = json.load(f)
        else:
            all_feedback = []
        
        all_feedback.append(feedback_entry)
        
        with open(feedback_file, 'w', encoding='utf-8') as f:
            json.dump(all_feedback, f, ensure_ascii=False, indent=2)
    except Exception as e:
        st.error(f"í”¼ë“œë°± ì €ì¥ ì‹¤íŒ¨: {e}")

def display_system_stats(rag_system):
    """ì‹œìŠ¤í…œ í†µê³„ í‘œì‹œ"""
    if rag_system:
        try:
            stats = rag_system.get_stats()
            
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric(
                    label="ğŸ“š ë¡œë“œëœ ë¬¸ì„œ",
                    value=f"{stats['document_stats']['total_documents']:,}ê°œ"
                )
            
            with col2:
                st.metric(
                    label="ğŸ§  ì´ ì„ë² ë”©",
                    value=f"{stats['document_stats']['total_embeddings']:,}ê°œ"
                )
            
            with col3:
                st.metric(
                    label="ğŸ” ê²€ìƒ‰ íšŸìˆ˜",
                    value=f"{stats['search_performance']['searches_performed']:,}íšŒ"
                )
            
            with col4:
                st.metric(
                    label="âš¡ í‰ê·  ì‘ë‹µì‹œê°„",
                    value=f"{stats['search_performance']['average_response_time']:.1f}ì´ˆ"
                )
            
            # ìºì‹œ íš¨ìœ¨ì„± ì°¨íŠ¸
            cache_hit_rate = stats['cache_info']['cache_hit_rate'] * 100
            
            fig = go.Figure(go.Indicator(
                mode = "gauge+number+delta",
                value = cache_hit_rate,
                domain = {'x': [0, 1], 'y': [0, 1]},
                title = {'text': "ğŸ’¾ ìºì‹œ ì ì¤‘ë¥ "},
                delta = {'reference': 80},
                gauge = {
                    'axis': {'range': [None, 100]},
                    'bar': {'color': "darkblue"},
                    'steps': [
                        {'range': [0, 50], 'color': "lightgray"},
                        {'range': [50, 80], 'color': "yellow"},
                        {'range': [80, 100], 'color': "green"}
                    ],
                    'threshold': {
                        'line': {'color': "red", 'width': 4},
                        'thickness': 0.75,
                        'value': 90
                    }
                }
            ))
            
            fig.update_layout(height=300)
            st.plotly_chart(fig, use_container_width=True)
            
        except Exception as e:
            st.error(f"í†µê³„ í‘œì‹œ ì˜¤ë¥˜: {e}")

def display_conversation_analytics():
    """ëŒ€í™” ë¶„ì„ í‘œì‹œ"""
    if not st.session_state.conversation_history:
        st.info("ğŸ“­ ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # ì‘ë‹µì‹œê°„ ë¶„ì„
    response_times = [conv['response_time'] for conv in st.session_state.conversation_history]
    
    col1, col2 = st.columns(2)
    
    with col1:
        # ì‘ë‹µì‹œê°„ íˆìŠ¤í† ê·¸ë¨
        fig_hist = px.histogram(
            x=response_times,
            title="ğŸ“Š ì‘ë‹µì‹œê°„ ë¶„í¬",
            labels={'x': 'ì‘ë‹µì‹œê°„ (ì´ˆ)', 'y': 'ë¹ˆë„'},
            nbins=10
        )
        st.plotly_chart(fig_hist, use_container_width=True)
    
    with col2:
        # ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰
        timestamps = [datetime.fromisoformat(conv['timestamp']) for conv in st.session_state.conversation_history]
        hours = [ts.hour for ts in timestamps]
        
        fig_time = px.histogram(
            x=hours,
            title="ğŸ• ì‹œê°„ëŒ€ë³„ ì‚¬ìš©ëŸ‰",
            labels={'x': 'ì‹œê°„ (24ì‹œê°„)', 'y': 'ì§ˆë¬¸ ìˆ˜'},
            nbins=24
        )
        st.plotly_chart(fig_time, use_container_width=True)
    
    # ìµœê·¼ ëŒ€í™”ë“¤
    st.subheader("ğŸ’¬ ìµœê·¼ ëŒ€í™” ê¸°ë¡")
    recent_conversations = st.session_state.conversation_history[-5:]
    
    for i, conv in enumerate(reversed(recent_conversations)):
        with st.expander(f"Q{len(recent_conversations)-i}: {conv['question'][:50]}..."):
            st.write(f"**ì§ˆë¬¸:** {conv['question']}")
            st.write(f"**ë‹µë³€:** {conv['answer'][:200]}...")
            st.write(f"**ì‘ë‹µì‹œê°„:** {conv['response_time']:.1f}ì´ˆ")
            st.write(f"**ì‹œê°„:** {conv['timestamp'][:19]}")

def display_prompt_management_tab(rag_system, prompt_manager):
    """í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­ UI"""
    st.header("âœï¸ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬")
    
    # ì„¤ëª…
    st.markdown("""
    ì´ í˜ì´ì§€ì—ì„œëŠ” ì˜ë£Œ AI ì‹œìŠ¤í…œì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    í”„ë¡¬í”„íŠ¸ëŠ” AIì˜ ë™ì‘ ë°©ì‹ì„ ê²°ì •í•˜ëŠ” í•µì‹¬ ìš”ì†Œì…ë‹ˆë‹¤.
    """)
    
    # í”„ë¡¬í”„íŠ¸ íƒ€ì… ì„ íƒ
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("í”„ë¡¬í”„íŠ¸ ì„ íƒ")
        
        # Config í´ë˜ìŠ¤ ì„í¬íŠ¸
        from config import Config
        
        prompt_types = list(Config.get_system_prompts().keys())
        
        # í”„ë¡¬í”„íŠ¸ íƒ€ì… ì„ íƒ UI
        selected_prompt_type = st.selectbox(
            "í”„ë¡¬í”„íŠ¸ ìœ í˜•:",
            prompt_types,
            index=prompt_types.index(st.session_state.current_prompt_type) if st.session_state.current_prompt_type in prompt_types else 0
        )
        
        # ì„ íƒëœ í”„ë¡¬í”„íŠ¸ íƒ€ì… ì €ì¥
        st.session_state.current_prompt_type = selected_prompt_type
        
        # í”„ë¡¬í”„íŠ¸ ì„¤ëª…
        prompt_descriptions = {
            "RAG_SYSTEM_PROMPT": "ì£¼ìš” ë‹µë³€ ìƒì„±ì— ì‚¬ìš©ë˜ëŠ” í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤.",
            "ROUTER_SYSTEM_PROMPT": "ì§ˆë¬¸ì„ ì ì ˆí•œ ê²€ìƒ‰ ë°©ë²•ìœ¼ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.",
            "GRADER_SYSTEM_PROMPT": "ê²€ìƒ‰ëœ ë¬¸ì„œì˜ ê´€ë ¨ì„±ì„ í‰ê°€í•©ë‹ˆë‹¤.",
            "HALLUCINATION_SYSTEM_PROMPT": "ìƒì„±ëœ ë‹µë³€ì˜ í™˜ê°ì„ ê²€ì¶œí•©ë‹ˆë‹¤.",
            "REWRITER_SYSTEM_PROMPT": "ì§ˆë¬¸ì„ ê²€ìƒ‰ì— ìµœì í™”ëœ í˜•íƒœë¡œ ì¬ì‘ì„±í•©ë‹ˆë‹¤."
        }
        
        st.info(prompt_descriptions.get(selected_prompt_type, "ì´ í”„ë¡¬í”„íŠ¸ì— ëŒ€í•œ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."))
        
        # í”„ë¦¬ì…‹ ê´€ë¦¬
        st.subheader("í”„ë¦¬ì…‹ ê´€ë¦¬")
        
        # í”„ë¦¬ì…‹ ì €ì¥
        preset_name = st.text_input("í”„ë¦¬ì…‹ ì´ë¦„:", key="preset_name_input")
        if st.button("í˜„ì¬ í”„ë¡¬í”„íŠ¸ ì €ì¥", key="save_preset_button"):
            if preset_name:
                # í˜„ì¬ ìˆ˜ì •ëœ í”„ë¡¬í”„íŠ¸ í¬í•¨í•˜ì—¬ ì €ì¥
                all_prompts = Config.get_system_prompts()
                all_prompts.update(st.session_state.edited_prompts)
                
                success = prompt_manager.save_preset(preset_name, all_prompts)
                if success:
                    st.success(f"âœ… '{preset_name}' í”„ë¦¬ì…‹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                else:
                    st.error("âŒ í”„ë¦¬ì…‹ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
            else:
                st.warning("âš ï¸ í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        
        # í”„ë¦¬ì…‹ ëª©ë¡ ë° ë¡œë“œ
        presets = prompt_manager.get_preset_list()
        if presets:
            st.subheader("ì €ì¥ëœ í”„ë¦¬ì…‹")
            
            for preset in presets:
                col_a, col_b = st.columns([3, 1])
                with col_a:
                    st.write(f"**{preset['name']}** ({preset['prompt_count']}ê°œ í”„ë¡¬í”„íŠ¸)")
                with col_b:
                    if st.button("ë¡œë“œ", key=f"load_{preset['name']}"):
                        loaded_prompts = prompt_manager.load_preset(preset['name'])
                        if loaded_prompts:
                            # ëª¨ë“  í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸
                            for p_type, p_content in loaded_prompts.items():
                                Config.update_system_prompt(p_type, p_content)
                                st.session_state.edited_prompts[p_type] = p_content
                            
                            # ìƒˆë¡œê³ ì¹¨ í•„ìš”
                            st.success("âœ… í”„ë¦¬ì…‹ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤. ì ìš©ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.")
                            st.rerun()
                        else:
                            st.error("âŒ í”„ë¦¬ì…‹ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    
    with col2:
        st.subheader("í”„ë¡¬í”„íŠ¸ í¸ì§‘")
        
        # í˜„ì¬ í”„ë¡¬í”„íŠ¸ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        current_content = ""
        if selected_prompt_type in st.session_state.edited_prompts:
            current_content = st.session_state.edited_prompts[selected_prompt_type]
        else:
            current_content = getattr(Config, selected_prompt_type, "")
        
        # í”„ë¡¬í”„íŠ¸ í¸ì§‘ UI
        edited_content = st.text_area(
            "í”„ë¡¬í”„íŠ¸ ë‚´ìš©:",
            value=current_content,
            height=400,
            key=f"prompt_editor_{selected_prompt_type}"
        )
        
        # ë³€ê²½ ì—¬ë¶€ í™•ì¸
        is_changed = edited_content != current_content
        
        col_x, col_y, col_z = st.columns([1, 1, 2])
        
        with col_x:
            if st.button("ì ìš©", type="primary", disabled=not is_changed):
                # í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸
                success = Config.update_system_prompt(selected_prompt_type, edited_content)
                
                if success:
                    # ì„¸ì…˜ì— ë³€ê²½ì‚¬í•­ ì €ì¥
                    st.session_state.edited_prompts[selected_prompt_type] = edited_content
                    
                    # ë³€ê²½ ì´ë ¥ ì¶”ê°€
                    st.session_state.prompt_edit_history.append({
                        "timestamp": datetime.now().isoformat(),
                        "prompt_type": selected_prompt_type,
                        "old_content": current_content[:100] + "..." if len(current_content) > 100 else current_content,
                        "new_content": edited_content[:100] + "..." if len(edited_content) > 100 else edited_content
                    })
                    
                    st.success("âœ… í”„ë¡¬í”„íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    
                    # RAG ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ ìƒˆë¡œê³ ì¹¨
                    if hasattr(rag_system, 'refresh_components'):
                        try:
                            rag_system.refresh_components()
                            st.success("âœ… RAG ì‹œìŠ¤í…œì´ ìƒˆ í”„ë¡¬í”„íŠ¸ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        except Exception as e:
                            st.error(f"âŒ RAG ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {str(e)}")
                else:
                    st.error("âŒ í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        
        with col_y:
            if st.button("ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›", disabled=not is_changed):
                # ì›ë˜ Configì˜ í”„ë¡¬í”„íŠ¸ë¡œ ë³µì›
                original_content = getattr(Config, selected_prompt_type, "")
                
                # ì„¸ì…˜ ìƒíƒœì—ì„œ ì œê±°
                if selected_prompt_type in st.session_state.edited_prompts:
                    del st.session_state.edited_prompts[selected_prompt_type]
                
                # Config ì—…ë°ì´íŠ¸
                Config.update_system_prompt(selected_prompt_type, original_content)
                
                st.success("âœ… ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.rerun()
    
    # ë³€ê²½ ì´ë ¥ í‘œì‹œ
    if st.session_state.prompt_edit_history:
        st.subheader("í”„ë¡¬í”„íŠ¸ ë³€ê²½ ì´ë ¥")
        
        history_df = pd.DataFrame(st.session_state.prompt_edit_history)
        # ë‚ ì§œ í˜•ì‹ ë³€í™˜
        history_df['timestamp'] = pd.to_datetime(history_df['timestamp']).dt.strftime('%Y-%m-%d %H:%M:%S')
        
        # í…Œì´ë¸” í‘œì‹œ
        st.dataframe(
            history_df[['timestamp', 'prompt_type', 'old_content', 'new_content']],
            column_config={
                "timestamp": "ë³€ê²½ ì‹œê°„",
                "prompt_type": "í”„ë¡¬í”„íŠ¸ ìœ í˜•",
                "old_content": "ì´ì „ ë‚´ìš©",
                "new_content": "ìƒˆ ë‚´ìš©"
            },
            use_container_width=True
        )
        
        if st.button("ì´ë ¥ ì´ˆê¸°í™”", key="clear_history"):
            st.session_state.prompt_edit_history = []
            st.success("âœ… ë³€ê²½ ì´ë ¥ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
            st.rerun()

def main():
    """ë©”ì¸ ì•±"""
    initialize_session_state()
    
    # í—¤ë”
    st.title("ğŸ¥ ì˜ë£Œ AI ì–´ì‹œìŠ¤í„´íŠ¸")
    st.markdown("---")
    
    # RAG ì‹œìŠ¤í…œ ë¡œë“œ
    rag_system = load_rag_system()
    
    # í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ì ë¡œë“œ
    prompt_manager = load_prompt_manager()
    
    if not rag_system:
        st.error("âŒ ì‹œìŠ¤í…œì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.")
        st.stop()
    
    # ì‚¬ì´ë“œë°”
    with st.sidebar:
        st.header("ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©")
        display_system_stats(rag_system)
        
        st.markdown("---")
        
        # ì‚¬ìš© ì•ˆë‚´
        st.header("ğŸ’¡ ì‚¬ìš© ì•ˆë‚´")
        st.markdown("""
        **ì§ˆë¬¸ ì˜ˆì‹œ:**
        - ë‹¹ë‡¨ë³‘ ê´€ë¦¬ ë°©ë²•ì€?
        - ê³ í˜ˆì•• ì‘ê¸‰ì²˜ì¹˜ ì ˆì°¨ëŠ”?
        - ì‹¬ì •ì§€ í™˜ì CPR ë°©ë²•ì€?
        
        **ì£¼ì˜ì‚¬í•­:**
        - ì‘ê¸‰ìƒí™©ì‹œ 119 ì‹ ê³  í•„ìˆ˜
        - AI ë‹µë³€ì€ ì°¸ê³ ìš©ì´ë©° ì „ë¬¸ì˜ ì§„ë£Œ í•„ìš”
        """)
        
        st.markdown("---")
        
        # ì ‘ì†ì ì •ë³´
        st.header("ğŸ‘¥ ì ‘ì† ì •ë³´")
        st.write(f"**ì‚¬ìš©ì ID:** {st.session_state.user_id}")
        st.write(f"**ì§ˆë¬¸ ìˆ˜:** {len(st.session_state.conversation_history)}ê°œ")
        
        if st.button("ğŸ”„ ì„¸ì…˜ ì´ˆê¸°í™”"):
            st.session_state.conversation_history = []
            st.session_state.user_feedback = []
            st.rerun()
    
    # ë©”ì¸ ì˜ì—­ - íƒ­ êµ¬ì¡° ìˆ˜ì •
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ’¬ ì§ˆë¬¸í•˜ê¸°", "ğŸ“ˆ ëŒ€í™” ë¶„ì„", "âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •", "âœï¸ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬"])
    
    with tab1:
        st.header("ğŸ’¬ ì˜ë£Œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”")
        
        # ì§ˆë¬¸ ì…ë ¥
        question = st.text_area(
            "ì§ˆë¬¸:",
            placeholder="ì˜ˆ: ë‹¹ë‡¨ë³‘ í™˜ìì˜ í˜ˆë‹¹ ê´€ë¦¬ ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”",
            height=100
        )
        
        col1, col2, col3 = st.columns([1, 1, 4])
        
        with col1:
            submit_button = st.button("ğŸš€ ì§ˆë¬¸í•˜ê¸°", type="primary")
        
        with col2:
            clear_button = st.button("ğŸ—‘ï¸ ì§€ìš°ê¸°")
        
        if clear_button:
            st.rerun()
        
        # ë‹µë³€ ìƒì„±
        if submit_button and question.strip():
            if len(question.strip()) < 5:
                st.warning("âš ï¸ ë” êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                with st.spinner("ğŸ¤” ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                    try:
                        start_time = time.time()
                        
                        # RAG ì‹œìŠ¤í…œìœ¼ë¡œ ë‹µë³€ ìƒì„±
                        result = rag_system.run_graph(question, st.session_state.user_id)
                        
                        end_time = time.time()
                        response_time = end_time - start_time
                        
                        # ê²°ê³¼ ì²˜ë¦¬
                        if isinstance(result, dict):
                            answer = result.get("answer", str(result))
                            sources_count = len(result.get("source_breakdown", {}).get("rag", []))
                        else:
                            answer = str(result)
                            sources_count = 0
                        
                        # ë‹µë³€ í‘œì‹œ
                        st.success("âœ… ë‹µë³€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        
                        # ë‹µë³€ ìƒì
                        with st.container():
                            st.markdown("### ğŸ¥ ë‹µë³€:")
                            st.markdown(f'<div style="background-color: #f0f2f6; padding: 20px; border-radius: 10px; border-left: 5px solid #1f77b4;">{answer}</div>', unsafe_allow_html=True)
                        
                        # ë©”íƒ€ ì •ë³´
                        col1, col2, col3 = st.columns(3)
                        with col1:
                            st.metric("â±ï¸ ì‘ë‹µì‹œê°„", f"{response_time:.1f}ì´ˆ")
                        with col2:
                            st.metric("ğŸ“š ì°¸ê³  ë¬¸ì„œ", f"{sources_count}ê°œ")
                        with col3:
                            current_time = datetime.now().strftime("%H:%M:%S")
                            st.metric("ğŸ• ìƒì„±ì‹œê°„", current_time)
                        
                        # ëŒ€í™” ì €ì¥
                        save_conversation(question, answer, response_time, sources_count)
                        
                        # ì‚¬ìš©ì í”¼ë“œë°±
                        st.markdown("---")
                        st.subheader("â­ ë‹µë³€ í‰ê°€")
                        
                        col1, col2, col3, col4 = st.columns(4)
                        
                        feedback_given = False
                        
                        with col1:
                            if st.button("ğŸ˜Š ë§¤ìš° ì¢‹ìŒ"):
                                save_feedback(question, answer, "excellent")
                                st.success("í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š")
                                feedback_given = True
                        
                        with col2:
                            if st.button("ğŸ‘ ì¢‹ìŒ"):
                                save_feedback(question, answer, "good")
                                st.success("í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‘")
                                feedback_given = True
                        
                        with col3:
                            if st.button("ğŸ˜ ë³´í†µ"):
                                save_feedback(question, answer, "average")
                                st.info("í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜")
                                feedback_given = True
                        
                        with col4:
                            if st.button("ğŸ˜ ë³„ë¡œ"):
                                save_feedback(question, answer, "poor")
                                st.warning("í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤! ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤. ğŸ˜")
                                feedback_given = True
                        
                        # ì¶”ê°€ í”¼ë“œë°±
                        if feedback_given:
                            additional_feedback = st.text_area("ì¶”ê°€ ì˜ê²¬ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”:", key="additional_feedback")
                            if st.button("ì˜ê²¬ ì œì¶œ") and additional_feedback:
                                # ë§ˆì§€ë§‰ í”¼ë“œë°± ì—…ë°ì´íŠ¸
                                if st.session_state.user_feedback:
                                    st.session_state.user_feedback[-1]['feedback_text'] = additional_feedback
                                st.success("ì¶”ê°€ ì˜ê²¬ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        
                    except Exception as e:
                        st.error(f"âŒ ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
                        st.info("ğŸ’¡ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
        
        elif submit_button:
            st.warning("âš ï¸ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        
        # ìµœê·¼ ì§ˆë¬¸ë“¤ í‘œì‹œ
        if st.session_state.conversation_history:
            st.markdown("---")
            st.subheader("ğŸ“ ìµœê·¼ ì§ˆë¬¸ë“¤")
            
            for i, conv in enumerate(reversed(st.session_state.conversation_history[-3:])):
                with st.expander(f"Q{len(st.session_state.conversation_history)-i}: {conv['question'][:60]}..."):
                    st.write(f"**ì§ˆë¬¸:** {conv['question']}")
                    st.write(f"**ë‹µë³€:** {conv['answer'][:300]}...")
                    st.write(f"**ì‘ë‹µì‹œê°„:** {conv['response_time']:.1f}ì´ˆ")
    
    with tab2:
        st.header("ğŸ“ˆ ëŒ€í™” ë¶„ì„")
        display_conversation_analytics()
    
    with tab3:
        st.header("âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("ğŸ”§ ì„¤ì • ì˜µì…˜")
            
            # ì‘ë‹µ ëª¨ë“œ ì„¤ì •
            response_mode = st.selectbox(
                "ì‘ë‹µ ëª¨ë“œ:",
                ["ìƒì„¸ ë‹µë³€", "ê°„ë‹¨ ë‹µë³€", "ìš”ì•½ ë‹µë³€"],
                index=0
            )
            
            # ì•ˆì „ ëª¨ë“œ
            safety_mode = st.checkbox("ğŸ›¡ï¸ ì•ˆì „ ëª¨ë“œ (ì‘ê¸‰ìƒí™© ìš°ì„  ì•Œë¦¼)", value=True)
            
            # ì†ŒìŠ¤ í‘œì‹œ
            show_sources = st.checkbox("ğŸ“š ì°¸ê³  ë¬¸ì„œ í‘œì‹œ", value=True)
            
        with col2:
            st.subheader("ğŸ“Š ì‚¬ìš© í†µê³„")
            
            if st.session_state.conversation_history:
                total_questions = len(st.session_state.conversation_history)
                avg_response_time = sum(conv['response_time'] for conv in st.session_state.conversation_history) / total_questions
                
                st.metric("ì´ ì§ˆë¬¸ ìˆ˜", f"{total_questions}ê°œ")
                st.metric("í‰ê·  ì‘ë‹µì‹œê°„", f"{avg_response_time:.1f}ì´ˆ")
                
                # í”¼ë“œë°± í†µê³„
                if st.session_state.user_feedback:
                    feedback_counts = {}
                    for feedback in st.session_state.user_feedback:
                        rating = feedback['rating']
                        feedback_counts[rating] = feedback_counts.get(rating, 0) + 1
                    
                    st.write("**ì‚¬ìš©ì í‰ê°€:**")
                    for rating, count in feedback_counts.items():
                        st.write(f"- {rating}: {count}ê°œ")
        
        # ì‹œìŠ¤í…œ ì •ë³´
        st.markdown("---")
        st.subheader("ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´")
        
        if rag_system:
            stats = rag_system.get_stats()
            
            system_info = {
                "ì„ë² ë”© ëª¨ë¸": stats['model_info']['embedding_model'],
                "ì„ë² ë”© ì°¨ì›": f"{stats['model_info']['dimensions']:,}",
                "ì´ ë¬¸ì„œ ìˆ˜": f"{stats['document_stats']['total_documents']:,}ê°œ",
                "ì¹´í…Œê³ ë¦¬ ìˆ˜": f"{stats['document_stats']['index_categories']:,}ê°œ",
                "ì˜ˆìƒ ë¹„ìš©": f"${stats['cost_estimate']['estimated_cost_usd']:.4f}"
            }
            
            for key, value in system_info.items():
                st.write(f"**{key}:** {value}")
    
    with tab4:
        # í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­
        if prompt_manager:
            display_prompt_management_tab(rag_system, prompt_manager)
        else:
            st.error("âŒ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ìë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            st.info("prompt_manager.py íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ ì½”ë“œë¥¼ prompt_manager.py íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”.")
            
            with st.expander("prompt_manager.py ì½”ë“œ"):
                st.code("""
import json
import os
from typing import Dict, List, Any, Optional
from pathlib import Path
from datetime import datetime

class PromptManager:
    \"\"\"í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í´ë˜ìŠ¤ - ì €ì¥, ë¡œë“œ, í”„ë¦¬ì…‹ ê´€ë¦¬\"\"\"
    
    def __init__(self, preset_dir: str = "./prompt_presets"):
        \"\"\"
        í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ì ì´ˆê¸°í™”
        
        Args:
            preset_dir: í”„ë¦¬ì…‹ ì €ì¥ ë””ë ‰í† ë¦¬
        \"\"\"
        self.preset_dir = Path(preset_dir)
        self.preset_dir.mkdir(exist_ok=True)
        
        # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ íƒ€ì…
        self.prompt_types = [
            "RAG_SYSTEM_PROMPT", 
            "ROUTER_SYSTEM_PROMPT",
            "GRADER_SYSTEM_PROMPT",
            "HALLUCINATION_SYSTEM_PROMPT",
            "REWRITER_SYSTEM_PROMPT"
        ]
        
        # í”„ë¦¬ì…‹ ëª©ë¡ ìºì‹œ
        self._preset_list_cache = None
        
    def get_prompt(self, prompt_type: str, config_obj) -> str:
        \"\"\"
        í˜„ì¬ ì„¤ì •ì—ì„œ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
        
        Args:
            prompt_type: í”„ë¡¬í”„íŠ¸ íƒ€ì… (ì˜ˆ: "RAG_SYSTEM_PROMPT")
            config_obj: Config í´ë˜ìŠ¤ ê°ì²´
            
        Returns:
            í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸
        \"\"\"
        if hasattr(config_obj, prompt_type):
            return getattr(config_obj, prompt_type)
        return f"í”„ë¡¬í”„íŠ¸ '{prompt_type}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    def update_prompt(self, prompt_type: str, new_content: str, config_obj) -> bool:
        \"\"\"
        í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸
        
        Args:
            prompt_type: í”„ë¡¬í”„íŠ¸ íƒ€ì…
            new_content: ìƒˆ í”„ë¡¬í”„íŠ¸ ë‚´ìš©
            config_obj: Config í´ë˜ìŠ¤ ê°ì²´
            
        Returns:
            ì„±ê³µ ì—¬ë¶€
        \"\"\"
        try:
            if hasattr(config_obj, prompt_type):
                setattr(config_obj, prompt_type, new_content)
                return True
            return False
        except Exception as e:
            print(f"í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {str(e)}")
            return False
    
    def save_preset(self, preset_name: str, prompts: Dict[str, str]) -> bool:
        \"\"\"
        í”„ë¡¬í”„íŠ¸ í”„ë¦¬ì…‹ ì €ì¥
        
        Args:
            preset_name: í”„ë¦¬ì…‹ ì´ë¦„
            prompts: í”„ë¡¬í”„íŠ¸ íƒ€ì…ë³„ ë‚´ìš©
            
        Returns:
            ì„±ê³µ ì—¬ë¶€
        \"\"\"
        try:
            # íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            safe_name = preset_name.replace(" ", "_").lower()
            preset_file = self.preset_dir / f"{safe_name}.json"
            
            preset_data = {
                "name": preset_name,
                "created_at": datetime.now().isoformat(),
                "prompts": prompts
            }
            
            with open(preset_file, 'w', encoding='utf-8') as f:
                json.dump(preset_data, f, ensure_ascii=False, indent=2)
            
            # ìºì‹œ ë¬´íš¨í™”
            self._preset_list_cache = None
            
            return True
        except Exception as e:
            print(f"í”„ë¦¬ì…‹ ì €ì¥ ì‹¤íŒ¨: {str(e)}")
            return False
    
    def load_preset(self, preset_name: str) -> Optional[Dict[str, str]]:
        \"\"\"
        í”„ë¡¬í”„íŠ¸ í”„ë¦¬ì…‹ ë¡œë“œ
        
        Args:
            preset_name: í”„ë¦¬ì…‹ ì´ë¦„
            
        Returns:
            í”„ë¡¬í”„íŠ¸ ë”•ì…”ë„ˆë¦¬ ë˜ëŠ” None
        \"\"\"
        try:
            # íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            safe_name = preset_name.replace(" ", "_").lower()
            preset_file = self.preset_dir / f"{safe_name}.json"
            
            if not preset_file.exists():
                return None
            
            with open(preset_file, 'r', encoding='utf-8') as f:
                preset_data = json.load(f)
            
            return preset_data.get("prompts", {})
        except Exception as e:
            print(f"í”„ë¦¬ì…‹ ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
            return None
    
    def get_preset_list(self) -> List[Dict[str, Any]]:
        \"\"\"
        ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¦¬ì…‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        
        Returns:
            í”„ë¦¬ì…‹ ì •ë³´ ëª©ë¡
        \"\"\"
        # ìºì‹œëœ ëª©ë¡ ì‚¬ìš©
        if self._preset_list_cache is not None:
            return self._preset_list_cache
        
        presets = []
        try:
            for preset_file in self.preset_dir.glob("*.json"):
                try:
                    with open(preset_file, 'r', encoding='utf-8') as f:
                        preset_data = json.load(f)
                    
                    presets.append({
                        "name": preset_data.get("name", preset_file.stem),
                        "created_at": preset_data.get("created_at", "Unknown"),
                        "filename": preset_file.name,
                        "prompt_count": len(preset_data.get("prompts", {}))
                    })
                except:
                    # ì˜ëª»ëœ í˜•ì‹ì˜ íŒŒì¼ì€ ë¬´ì‹œ
                    continue
            
            # ìµœì‹ ìˆœ ì •ë ¬
            presets.sort(key=lambda x: x.get("created_at", ""), reverse=True)
            
            # ìºì‹œ ì—…ë°ì´íŠ¸
            self._preset_list_cache = presets
            
            return presets
        except Exception as e:
            print(f"í”„ë¦¬ì…‹ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
            return []
    
    def delete_preset(self, preset_name: str) -> bool:
        \"\"\"
        í”„ë¦¬ì…‹ ì‚­ì œ
        
        Args:
            preset_name: í”„ë¦¬ì…‹ ì´ë¦„
            
        Returns:
            ì„±ê³µ ì—¬ë¶€
        \"\"\"
        try:
            # íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            safe_name = preset_name.replace(" ", "_").lower()
            preset_file = self.preset_dir / f"{safe_name}.json"
            
            if preset_file.exists():
                preset_file.unlink()
                # ìºì‹œ ë¬´íš¨í™”
                self._preset_list_cache = None
                return True
            return False
        except Exception as e:
            print(f"í”„ë¦¬ì…‹ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")
            return False
                """, language="python")

if __name__ == "__main__":
    main()